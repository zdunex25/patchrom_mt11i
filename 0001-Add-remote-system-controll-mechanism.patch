From d4f9c167e4f8dd979e8d01bb8d68d3b92ea1053b Mon Sep 17 00:00:00 2001
From: mochangming <mochangming@xiaomi.com>
Date: Tue, 5 Nov 2013 10:56:14 +0800
Subject: [PATCH] Add remote system controll mechanism

Ref-Id: I5badc84a7c233509ae79b2aae562cdc0a05823f5
Change-Id: Ie7975e2ec88c7a2fc91598fb5732af3cbb77406a
---
 .../smali/android/app/ActivityManager.smali        |    2 +
 .../smali/android/content/pm/PackageInfoLite.smali |   16 ++++
 .../smali/android/content/pm/PackageManager.smali  |    4 +
 .../content/pm/PackageParser$PackageLite.smali     |   37 +++++++-
 .../smali/android/content/pm/PackageParser.smali   |   38 +++++++-
 .../com/android/server/AlarmManagerService.smali   |   22 ++++-
 .../android/server/am/ActivityManagerService.smali |   97 ++++++++++++++++++++
 .../com/android/server/am/ActivityStack.smali      |   53 +++++++++++
 .../android/server/pm/PackageManagerService.smali  |   22 +++--
 9 files changed, 278 insertions(+), 13 deletions(-)

diff --git a/framework.jar.out/smali/android/app/ActivityManager.smali b/framework.jar.out/smali/android/app/ActivityManager.smali
index 40c73a8..e1e07af 100644
--- a/framework.jar.out/smali/android/app/ActivityManager.smali
+++ b/framework.jar.out/smali/android/app/ActivityManager.smali
@@ -69,6 +69,8 @@
 
 .field public static final START_FORWARD_AND_REQUEST_CONFLICT:I = -0x3
 
+.field public static final START_INCOMPATIBLE:I = 0x5
+
 .field public static final START_INTENT_NOT_RESOLVED:I = -0x1
 
 .field public static final START_NOT_ACTIVITY:I = -0x5
diff --git a/framework.jar.out/smali/android/content/pm/PackageInfoLite.smali b/framework.jar.out/smali/android/content/pm/PackageInfoLite.smali
index 9edc57d..ea430ea 100644
--- a/framework.jar.out/smali/android/content/pm/PackageInfoLite.smali
+++ b/framework.jar.out/smali/android/content/pm/PackageInfoLite.smali
@@ -28,6 +28,8 @@
 
 .field public verifiers:[Landroid/content/pm/VerifierInfo;
 
+.field public versionCode:I
+
 
 # direct methods
 .method static constructor <clinit>()V
@@ -49,6 +51,10 @@
     .prologue
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
+    const/4 v0, 0x0
+
+    iput v0, p0, Landroid/content/pm/PackageInfoLite;->versionCode:I
+
     return-void
 .end method
 
@@ -91,6 +97,12 @@
     iput-object v1, p0, Landroid/content/pm/PackageInfoLite;->verifiers:[Landroid/content/pm/VerifierInfo;
 
     :goto_0
+    invoke-virtual {p1}, Landroid/os/Parcel;->readInt()I
+
+    move-result v1
+
+    iput v1, p0, Landroid/content/pm/PackageInfoLite;->versionCode:I
+
     return-void
 
     :cond_0
@@ -214,6 +226,10 @@
     invoke-virtual {p1, v0}, Landroid/os/Parcel;->writeInt(I)V
 
     :goto_0
+    iget v0, p0, Landroid/content/pm/PackageInfoLite;->versionCode:I
+
+    invoke-virtual {p1, v0}, Landroid/os/Parcel;->writeInt(I)V
+
     return-void
 
     :cond_1
diff --git a/framework.jar.out/smali/android/content/pm/PackageManager.smali b/framework.jar.out/smali/android/content/pm/PackageManager.smali
index 42726ab..63248c6 100644
--- a/framework.jar.out/smali/android/content/pm/PackageManager.smali
+++ b/framework.jar.out/smali/android/content/pm/PackageManager.smali
@@ -177,6 +177,8 @@
 
 .field public static final INSTALL_FAILED_CONTAINER_ERROR:I = -0x12
 
+.field public static final INSTALL_FAILED_CONTAIN_VIRUS:I = -0x19
+
 .field public static final INSTALL_FAILED_CPU_ABI_INCOMPATIBLE:I = -0x10
 
 .field public static final INSTALL_FAILED_DEXOPT:I = -0xb
@@ -211,6 +213,8 @@
 
 .field public static final INSTALL_FAILED_SHARED_USER_INCOMPATIBLE:I = -0x8
 
+.field public static final INSTALL_FAILED_SYSTEM_INCOMPATIBLE:I = -0x1a
+
 .field public static final INSTALL_FAILED_TEST_ONLY:I = -0xf
 
 .field public static final INSTALL_FAILED_UID_CHANGED:I = -0x18
diff --git a/framework.jar.out/smali/android/content/pm/PackageParser$PackageLite.smali b/framework.jar.out/smali/android/content/pm/PackageParser$PackageLite.smali
index d077bca..eae87d3 100644
--- a/framework.jar.out/smali/android/content/pm/PackageParser$PackageLite.smali
+++ b/framework.jar.out/smali/android/content/pm/PackageParser$PackageLite.smali
@@ -21,11 +21,14 @@
 
 .field public final verifiers:[Landroid/content/pm/VerifierInfo;
 
+.field public final versionCode:I
+
 
 # direct methods
-.method public constructor <init>(Ljava/lang/String;ILjava/util/List;)V
+.method public constructor <init>(Ljava/lang/String;IILjava/util/List;)V
     .locals 1
     .parameter "packageName"
+    .parameter "versionCode"
     .parameter "installLocation"
     .parameter
     .annotation system Ldalvik/annotation/Signature;
@@ -46,7 +49,9 @@
 
     iput-object p1, p0, Landroid/content/pm/PackageParser$PackageLite;->packageName:Ljava/lang/String;
 
-    iput p2, p0, Landroid/content/pm/PackageParser$PackageLite;->installLocation:I
+    iput p2, p0, Landroid/content/pm/PackageParser$PackageLite;->versionCode:I
+
+    iput p3, p0, Landroid/content/pm/PackageParser$PackageLite;->installLocation:I
 
     invoke-interface {p3}, Ljava/util/List;->size()I
 
@@ -54,7 +59,7 @@
 
     new-array v0, v0, [Landroid/content/pm/VerifierInfo;
 
-    invoke-interface {p3, v0}, Ljava/util/List;->toArray([Ljava/lang/Object;)[Ljava/lang/Object;
+    invoke-interface {p4, v0}, Ljava/util/List;->toArray([Ljava/lang/Object;)[Ljava/lang/Object;
 
     move-result-object v0
 
@@ -64,3 +69,29 @@
 
     return-void
 .end method
+
+.method public constructor <init>(Ljava/lang/String;ILjava/util/List;)V
+    .locals 1
+    .parameter "packageName"
+    .parameter "installLocation"
+    .parameter
+    .annotation system Ldalvik/annotation/Signature;
+        value = {
+            "(",
+            "Ljava/lang/String;",
+            "I",
+            "Ljava/util/List",
+            "<",
+            "Landroid/content/pm/VerifierInfo;",
+            ">;)V"
+        }
+    .end annotation
+
+    .prologue
+    .local p3, verifiers:Ljava/util/List;,"Ljava/util/List<Landroid/content/pm/VerifierInfo;>;"
+    const/4 v0, 0x0
+
+    invoke-direct {p0, p1, v0, p2, p3}, Landroid/content/pm/PackageParser$PackageLite;-><init>(Ljava/lang/String;IILjava/util/List;)V
+
+    return-void
+.end method
diff --git a/framework.jar.out/smali/android/content/pm/PackageParser.smali b/framework.jar.out/smali/android/content/pm/PackageParser.smali
index a1ee590..3e361b5 100644
--- a/framework.jar.out/smali/android/content/pm/PackageParser.smali
+++ b/framework.jar.out/smali/android/content/pm/PackageParser.smali
@@ -9280,7 +9280,7 @@
 .end method
 
 .method private static parsePackageLite(Landroid/content/res/Resources;Lorg/xmlpull/v1/XmlPullParser;Landroid/util/AttributeSet;I[Ljava/lang/String;)Landroid/content/pm/PackageParser$PackageLite;
-    .locals 12
+    .locals 14
     .parameter "res"
     .parameter "parser"
     .parameter "attrs"
@@ -9442,6 +9442,12 @@
     const/4 v2, -0x1
 
     .local v2, installLocation:I
+    const/4 v12, 0x0
+
+    .local v12, versionCode:I
+    const/4 v13, 0x0
+
+    .local v13, numFound:I
     const/4 v1, 0x0
 
     .local v1, i:I
@@ -9463,7 +9469,7 @@
 
     move-result v9
 
-    if-eqz v9, :cond_a
+    if-eqz v9, :cond_miui_0
 
     const/4 v9, -0x1
 
@@ -9471,6 +9477,32 @@
 
     move-result v2
 
+    add-int/lit8 v13, v13, 0x1
+
+    goto :cond_miui_1
+
+    :cond_miui_0
+    const-string v9, "versionCode"
+
+    invoke-virtual {v0, v9}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v9
+
+    if-eqz v9, :cond_miui_1
+
+    const/4 v9, -0x1
+
+    invoke-interface {p2, v1, v9}, Landroid/util/AttributeSet;->getAttributeIntValue(II)I
+
+    move-result v12
+
+    add-int/lit8 v13, v13, 0x1
+
+    :cond_miui_1
+    const/4 v9, 0x2
+
+    if-lt v13, v9, :cond_a
+
     .end local v0           #attr:Ljava/lang/String;
     :cond_7
     invoke-interface {p1}, Lorg/xmlpull/v1/XmlPullParser;->getDepth()I
@@ -9562,7 +9594,7 @@
 
     move-result-object v10
 
-    invoke-direct {v9, v10, v2, v8}, Landroid/content/pm/PackageParser$PackageLite;-><init>(Ljava/lang/String;ILjava/util/List;)V
+    invoke-direct {v9, v12, v10, v2, v8}, Landroid/content/pm/PackageParser$PackageLite;-><init>(Ljava/lang/String;IILjava/util/List;)V
 
     goto/16 :goto_0
 .end method
diff --git a/services.jar.out/smali/com/android/server/AlarmManagerService.smali b/services.jar.out/smali/com/android/server/AlarmManagerService.smali
index 2dfa504..c535088 100644
--- a/services.jar.out/smali/com/android/server/AlarmManagerService.smali
+++ b/services.jar.out/smali/com/android/server/AlarmManagerService.smali
@@ -2055,7 +2055,7 @@
 .end method
 
 .method public setRepeating(IJJLandroid/app/PendingIntent;)V
-    .locals 4
+    .locals 6
     .parameter "type"
     .parameter "triggerAtTime"
     .parameter "interval"
@@ -2074,6 +2074,26 @@
     return-void
 
     :cond_0
+    iget-object v0, p0, Lcom/android/server/AlarmManagerService;->mContext:Landroid/content/Context;
+
+    move v1, p1
+
+    move-wide v2, p2
+
+    move-wide v4, p4
+
+    invoke-static/range {v0 .. v5}, Lcom/android/server/ExtraAlarmManagerService;->alignAlarm(Landroid/content/Context;IJJ)[J
+
+    move-result-object v2
+
+    const/4 v0, 0x0
+
+    aget-wide p2, v2, v0
+
+    const/4 v0, 0x1
+
+    aget-wide p4, v2, v0
+
     iget-object v3, p0, Lcom/android/server/AlarmManagerService;->mLock:Ljava/lang/Object;
 
     monitor-enter v3
diff --git a/services.jar.out/smali/com/android/server/am/ActivityManagerService.smali b/services.jar.out/smali/com/android/server/am/ActivityManagerService.smali
index a726a13..d4f586a 100644
--- a/services.jar.out/smali/com/android/server/am/ActivityManagerService.smali
+++ b/services.jar.out/smali/com/android/server/am/ActivityManagerService.smali
@@ -29321,6 +29321,25 @@
 
     invoke-direct {v0, v4, v1}, Lcom/android/server/am/ActivityManagerService;->checkValidCaller(II)V
 
+    move-object/from16 v0, p0
+
+    move-object/from16 v1, p3
+
+    move-object/from16 v2, p4
+
+    move/from16 v3, p7
+
+    invoke-direct {v0, v1, v2, v3}, Lcom/android/server/am/ActivityManagerService;->checkRunningCompatibility(Landroid/content/Intent;Ljava/lang/String;I)Z
+
+    move-result v6
+
+    if-nez v6, :cond_miui_0
+
+    const/4 v6, -0x1
+
+    return v6
+
+    :cond_miui_0
     monitor-enter p0
 
     :try_start_0
@@ -60677,6 +60696,17 @@
     throw v0
 
     :cond_0
+    invoke-direct {p0, p2, p3}, Lcom/android/server/am/ActivityManagerService;->checkRunningCompatibility(Landroid/content/Intent;Ljava/lang/String;)Z
+
+    move-result v8
+
+    if-nez v8, :cond_miui_0
+
+    const/4 v8, 0x0
+
+    return-object v8
+
+    :cond_miui_0
     monitor-enter p0
 
     :try_start_0
@@ -66981,3 +67011,70 @@
 
     goto :goto_1
 .end method
+
+.method private checkRunningCompatibility(Landroid/content/Intent;Ljava/lang/String;)Z
+    .locals 2
+    .parameter "service"
+    .parameter "resolvedType"
+
+    .prologue
+    iget-boolean v0, p0, Lcom/android/server/am/ActivityManagerService;->mSystemReady:Z
+
+    if-eqz v0, :cond_0
+
+    iget-object v0, p0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+
+    invoke-static {}, Landroid/os/Binder;->getCallingUid()I
+
+    move-result v1
+
+    invoke-static {v1}, Landroid/os/UserId;->getUserId(I)I
+
+    move-result v1
+
+    invoke-static {v0, p1, p2, v1}, Lcom/android/server/am/ExtraActivityManagerService;->checkRunningCompatibility(Landroid/content/Context;Landroid/content/Intent;Ljava/lang/String;I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    const/4 v0, 0x0
+
+    :goto_0
+    return v0
+
+    :cond_0
+    const/4 v0, 0x1
+
+    goto :goto_0
+.end method
+
+.method private checkRunningCompatibility(Landroid/content/Intent;Ljava/lang/String;I)Z
+    .locals 1
+    .parameter "service"
+    .parameter "resolvedType"
+    .parameter "userId"
+
+    .prologue
+    iget-boolean v0, p0, Lcom/android/server/am/ActivityManagerService;->mSystemReady:Z
+
+    if-eqz v0, :cond_0
+
+    iget-object v0, p0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+
+    invoke-static {v0, p1, p2, p3}, Lcom/android/server/am/ExtraActivityManagerService;->checkRunningCompatibility(Landroid/content/Context;Landroid/content/Intent;Ljava/lang/String;I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    const/4 v0, 0x0
+
+    :goto_0
+    return v0
+
+    :cond_0
+    const/4 v0, 0x1
+
+    goto :goto_0
+.end method
diff --git a/services.jar.out/smali/com/android/server/am/ActivityStack.smali b/services.jar.out/smali/com/android/server/am/ActivityStack.smali
index ea90bd7..cdbf9f3 100644
--- a/services.jar.out/smali/com/android/server/am/ActivityStack.smali
+++ b/services.jar.out/smali/com/android/server/am/ActivityStack.smali
@@ -12291,6 +12291,19 @@
     move-result-object v12
 
     .local v12, aInfo:Landroid/content/pm/ActivityInfo;
+    move-object/from16 v0, p0
+
+    invoke-direct {v0, v12}, Lcom/android/server/am/ActivityStack;->checkRunningCompatibility(Landroid/content/pm/ActivityInfo;)Z
+
+    move-result v2
+
+    if-nez v2, :cond_miui_0
+
+    const/4 v2, 0x5
+
+    return v2
+
+    :cond_miui_0
     if-eqz v12, :cond_1
 
     move-object/from16 v0, p0
@@ -14985,3 +14998,43 @@
 
     return-void
 .end method
+
+.method private checkRunningCompatibility(Landroid/content/pm/ActivityInfo;)Z
+    .locals 2
+    .parameter "aInfo"
+
+    .prologue
+    iget-object v0, p0, Lcom/android/server/am/ActivityStack;->mService:Lcom/android/server/am/ActivityManagerService;
+
+    iget-boolean v0, v0, Lcom/android/server/am/ActivityManagerService;->mSystemReady:Z
+
+    if-eqz v0, :cond_1
+
+    iget-object v1, p0, Lcom/android/server/am/ActivityStack;->mContext:Landroid/content/Context;
+
+    if-eqz p1, :cond_0
+
+    iget-object v0, p1, Landroid/content/pm/ActivityInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
+
+    :goto_0
+    invoke-static {v1, v0}, Lcom/android/server/am/ExtraActivityManagerService;->checkRunningCompatibility(Landroid/content/Context;Landroid/content/pm/ApplicationInfo;)Z
+
+    move-result v0
+
+    if-nez v0, :cond_1
+
+    const/4 v0, 0x0
+
+    :goto_1
+    return v0
+
+    :cond_0
+    const/4 v0, 0x0
+
+    goto :goto_0
+
+    :cond_1
+    const/4 v0, 0x1
+
+    goto :goto_1
+.end method
diff --git a/services.jar.out/smali/com/android/server/pm/PackageManagerService.smali b/services.jar.out/smali/com/android/server/pm/PackageManagerService.smali
index 1c3904b..3026a7a 100644
--- a/services.jar.out/smali/com/android/server/pm/PackageManagerService.smali
+++ b/services.jar.out/smali/com/android/server/pm/PackageManagerService.smali
@@ -9200,11 +9200,13 @@
     goto :goto_0
 
     :cond_4
-    iget-object v0, p1, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
+    iget-object v0, p0, Lcom/android/server/pm/PackageManagerService;->mContext:Landroid/content/Context;
 
-    iget-object v1, p0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
+    iget-object v1, p1, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
 
-    invoke-static {v0, v1}, Lcom/android/server/pm/ExtraPackageManagerServices;->postProcessNewInstall(Landroid/content/pm/ApplicationInfo;Lcom/android/server/pm/Settings;)V
+    iget-object v2, p0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
+
+    invoke-static {v0, v1, v2}, Lcom/android/server/pm/ExtraPackageManagerServices;->postProcessNewInstall(Landroid/content/Context;Landroid/content/pm/ApplicationInfo;Lcom/android/server/pm/Settings;)V
 
     invoke-direct {p0, v7, p4, p5}, Lcom/android/server/pm/PackageManagerService;->updateSettingsLI(Landroid/content/pm/PackageParser$Package;Ljava/lang/String;Lcom/android/server/pm/PackageManagerService$PackageInstalledInfo;)V
 
@@ -16509,15 +16511,19 @@
 
     :cond_3e
     :goto_14
+    move-object/from16 v0, p0
+
+    iget-object v3, v0, Lcom/android/server/pm/PackageManagerService;->mContext:Landroid/content/Context;
+
     move-object/from16 v0, p1
 
-    iget-object v3, v0, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
+    iget-object v10, v0, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
 
     move-object/from16 v0, p0
 
-    iget-object v10, v0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
+    iget-object v11, v0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
 
-    invoke-static {v3, v10}, Lcom/android/server/pm/ExtraPackageManagerServices;->blockAutoStartedApp(Landroid/content/pm/ApplicationInfo;Lcom/android/server/pm/Settings;)V
+    invoke-static {v3, v10, v11}, Lcom/android/server/pm/ExtraPackageManagerServices;->blockAutoStartedApp(Landroid/content/Context;Landroid/content/pm/ApplicationInfo;Lcom/android/server/pm/Settings;)V
 
     move-object/from16 v0, p1
 
@@ -34399,6 +34405,10 @@
     :goto_0
     invoke-static {v0}, Landroid/content/pm/PackageParser;->setCompatibilityModeEnabled(Z)V
 
+    iget-object v1, p0, Lcom/android/server/pm/PackageManagerService;->mContext:Landroid/content/Context;
+
+    invoke-static {v1}, Lmiui/provider/ExtraGuard;->init(Landroid/content/Context;)V
+
     return-void
 
     .end local v0           #compatibilityModeEnabled:Z
-- 
1.7.9.5

